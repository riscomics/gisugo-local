<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cleanup Duplicate Applications - GISUGO Admin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 30px;
      color: #856404;
    }
    
    .warning strong {
      display: block;
      margin-bottom: 5px;
    }
    
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 15px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .btn-danger:hover {
      box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);
    }
    
    .results {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .results h3 {
      margin-bottom: 15px;
      color: #333;
    }
    
    .result-item {
      padding: 10px;
      margin-bottom: 10px;
      background: white;
      border-radius: 5px;
      border-left: 4px solid #667eea;
    }
    
    .result-item.duplicate {
      border-left-color: #f5576c;
    }
    
    .result-item.kept {
      border-left-color: #28a745;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§¹ Cleanup Duplicate Applications</h1>
    <p class="subtitle">Remove duplicate applications from the same user to the same job</p>
    
    <div class="warning">
      <strong>âš ï¸ Warning:</strong>
      This tool will find and remove duplicate applications. For each job+user combination, only the FIRST application will be kept.
    </div>
    
    <div class="warning" style="background: #d1ecf1; border-color: #bee5eb; color: #0c5460;">
      <strong>â„¹ï¸ Smart Cleanup Enabled:</strong>
      Legitimate reapplications (1 rejected + 1 pending/accepted) are NOT flagged as duplicates. Only actual bugs/spam will be removed.
    </div>
    
    <button class="btn" id="scanBtn" onclick="scanDuplicates()">
      ğŸ” Scan for Duplicates
    </button>
    
    <button class="btn btn-danger" id="cleanupBtn" onclick="cleanupDuplicates()" disabled>
      ğŸ—‘ï¸ Remove Duplicates
    </button>
    
    <button class="btn" id="fixCountsBtn" onclick="fixApplicationCounts()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      ğŸ”§ Fix Application Counts
    </button>
    
    <button class="btn btn-danger" id="cleanOldGigsBtn" onclick="cleanOldGigs()">
      ğŸ—‘ï¸ Delete Old Test Gigs
    </button>
    
    <div class="results" id="results" style="display: none;"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  
  <!-- Firebase Config -->
  <script src="public/js/firebase-config.js"></script>
  
  <script>
    let duplicateApplications = [];
    
    async function scanDuplicates() {
      const scanBtn = document.getElementById('scanBtn');
      const cleanupBtn = document.getElementById('cleanupBtn');
      const results = document.getElementById('results');
      
      scanBtn.disabled = true;
      cleanupBtn.disabled = true;
      results.style.display = 'block';
      results.innerHTML = '<div class="loading"><div class="spinner"></div><p>Scanning applications...</p></div>';
      
      try {
        const db = firebase.firestore();
        const applicationsSnapshot = await db.collection('applications').get();
        
        console.log(`ğŸ“Š Total applications: ${applicationsSnapshot.size}`);
        
        // Group applications by jobId + applicantId
        const applicationGroups = {};
        
        applicationsSnapshot.forEach(doc => {
          const data = doc.data();
          const key = `${data.jobId}_${data.applicantId}`;
          
          if (!applicationGroups[key]) {
            applicationGroups[key] = [];
          }
          
          applicationGroups[key].push({
            id: doc.id,
            jobId: data.jobId,
            applicantId: data.applicantId,
            applicantName: data.applicantName,
            appliedAt: data.appliedAt,
            status: data.status
          });
        });
        
        // Find duplicates
        duplicateApplications = [];
        let totalDuplicates = 0;
        
        Object.keys(applicationGroups).forEach(key => {
          const apps = applicationGroups[key];
          
          if (apps.length > 1) {
            // Sort by appliedAt (keep the first one)
            apps.sort((a, b) => {
              const timeA = a.appliedAt?.toDate ? a.appliedAt.toDate().getTime() : 0;
              const timeB = b.appliedAt?.toDate ? b.appliedAt.toDate().getTime() : 0;
              return timeA - timeB;
            });
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // SMART CLEANUP: Check if this is a legitimate reapplication
            // (1 rejected + 1 pending/accepted is allowed by design)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (apps.length === 2) {
              const firstApp = apps[0];
              const secondApp = apps[1];
              
              // If first is rejected and second is pending/accepted, this is legitimate
              if (firstApp.status === 'rejected' && 
                  (secondApp.status === 'pending' || secondApp.status === 'accepted')) {
                console.log(`âœ… Legitimate reapplication for job ${firstApp.jobId} by ${firstApp.applicantName} (first rejected, second ${secondApp.status})`);
                return; // Skip this group - it's not a duplicate
              }
            }
            
            // Mark duplicates (all except the first one)
            const duplicates = apps.slice(1);
            duplicateApplications.push(...duplicates.map(app => app.id));
            totalDuplicates += duplicates.length;
            
            console.log(`ğŸ” Found ${duplicates.length} duplicate(s) for job ${apps[0].jobId} by ${apps[0].applicantName}`);
          }
        });
        
        // Display results
        if (totalDuplicates === 0) {
          results.innerHTML = `
            <h3>âœ… No Duplicates Found</h3>
            <p>All applications are unique. No cleanup needed!</p>
          `;
        } else {
          let html = `
            <h3>ğŸ” Scan Results</h3>
            <p><strong>${totalDuplicates} duplicate application(s) found</strong></p>
            <p style="margin-top: 10px; margin-bottom: 15px;">Click "Remove Duplicates" to clean them up.</p>
          `;
          
          Object.keys(applicationGroups).forEach(key => {
            const apps = applicationGroups[key];
            if (apps.length > 1) {
              html += `<div class="result-item">`;
              html += `<strong>${apps[0].applicantName}</strong> applied ${apps.length} times to job ${apps[0].jobId}<br>`;
              html += `<small>Keeping: ${apps[0].id} (${formatDate(apps[0].appliedAt)})</small><br>`;
              apps.slice(1).forEach(app => {
                html += `<small style="color: #f5576c;">Removing: ${app.id} (${formatDate(app.appliedAt)})</small><br>`;
              });
              html += `</div>`;
            }
          });
          
          results.innerHTML = html;
          cleanupBtn.disabled = false;
        }
      } catch (error) {
        console.error('âŒ Error scanning:', error);
        results.innerHTML = `
          <h3>âŒ Error</h3>
          <p>${error.message}</p>
        `;
      } finally {
        scanBtn.disabled = false;
      }
    }
    
    async function cleanupDuplicates() {
      if (duplicateApplications.length === 0) {
        alert('No duplicates to remove!');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${duplicateApplications.length} duplicate application(s)?\n\nThis action cannot be undone!`)) {
        return;
      }
      
      const cleanupBtn = document.getElementById('cleanupBtn');
      const results = document.getElementById('results');
      
      cleanupBtn.disabled = true;
      results.innerHTML = '<div class="loading"><div class="spinner"></div><p>Removing duplicates...</p></div>';
      
      try {
        const db = firebase.firestore();
        const batch = db.batch();
        
        duplicateApplications.forEach(appId => {
          batch.delete(db.collection('applications').doc(appId));
        });
        
        await batch.commit();
        
        console.log(`âœ… Deleted ${duplicateApplications.length} duplicate applications`);
        
        results.innerHTML = `
          <h3>âœ… Cleanup Complete</h3>
          <p><strong>${duplicateApplications.length} duplicate application(s) removed successfully!</strong></p>
          <p style="margin-top: 10px;">You can scan again to verify.</p>
        `;
        
        duplicateApplications = [];
      } catch (error) {
        console.error('âŒ Error cleaning up:', error);
        results.innerHTML = `
          <h3>âŒ Error</h3>
          <p>${error.message}</p>
        `;
        cleanupBtn.disabled = false;
      }
    }
    
    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown';
      if (timestamp.toDate) {
        return timestamp.toDate().toLocaleString();
      }
      return new Date(timestamp).toLocaleString();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FIX APPLICATION COUNTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function fixApplicationCounts() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('Please log in first!');
        return;
      }
      
      if (!confirm('This will recalculate application counts for ALL jobs based on pending applications only.\n\nContinue?')) {
        return;
      }
      
      const fixCountsBtn = document.getElementById('fixCountsBtn');
      const results = document.getElementById('results');
      
      fixCountsBtn.disabled = true;
      results.style.display = 'block';
      results.innerHTML = '<div class="loading"><div class="spinner"></div><p>Fixing application counts...</p></div>';
      
      try {
        const db = firebase.firestore();
        
        // Get all jobs
        const jobsSnapshot = await db.collection('jobs').get();
        let fixed = 0;
        let checked = 0;
        
        for (const jobDoc of jobsSnapshot.docs) {
          const jobId = jobDoc.id;
          const jobTitle = jobDoc.data().title || 'Untitled';
          checked++;
          
          // Count ONLY pending applications for this job
          const pendingApps = await db.collection('applications')
            .where('jobId', '==', jobId)
            .where('status', '==', 'pending')
            .get();
          
          const correctCount = pendingApps.size;
          const currentCount = jobDoc.data().applicationCount || 0;
          
          if (correctCount !== currentCount) {
            console.log(`ğŸ“Š "${jobTitle}": Fixing count from ${currentCount} to ${correctCount}`);
            await db.collection('jobs').doc(jobId).update({
              applicationCount: correctCount
            });
            fixed++;
          }
        }
        
        results.innerHTML = `
          <h3>âœ… Fix Complete</h3>
          <p><strong>Checked ${checked} job(s)</strong></p>
          <p><strong>Fixed ${fixed} job(s)</strong></p>
          <p style="margin-top: 10px; color: #666;">Application counts now show only pending applications!</p>
        `;
        
        console.log(`âœ… Fixed ${fixed} out of ${checked} jobs`);
        
      } catch (error) {
        console.error('âŒ Error fixing counts:', error);
        results.innerHTML = `
          <h3>âŒ Error</h3>
          <p>${error.message}</p>
        `;
      } finally {
        fixCountsBtn.disabled = false;
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLEAN OLD TEST GIGS (with timestamp IDs)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function cleanOldGigs() {
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('Please log in first!');
        return;
      }
      
      const results = document.getElementById('results');
      const cleanOldGigsBtn = document.getElementById('cleanOldGigsBtn');
      
      cleanOldGigsBtn.disabled = true;
      results.style.display = 'block';
      results.innerHTML = '<div class="loading"><div class="spinner"></div><p>Scanning for old test gigs...</p></div>';
      
      try {
        const db = firebase.firestore();
        const jobsSnapshot = await db.collection('jobs').get();
        
        const oldGigs = [];
        const timestampPattern = /^\d{13}$/; // 13-digit timestamps
        
        // Find gigs with timestamp-based IDs
        jobsSnapshot.docs.forEach(doc => {
          if (timestampPattern.test(doc.id)) {
            const data = doc.data();
            oldGigs.push({
              id: doc.id,
              title: data.title || 'Untitled',
              category: data.category || 'Unknown',
              datePosted: data.datePosted?.toDate?.()?.toLocaleDateString() || 'Unknown'
            });
          }
        });
        
        if (oldGigs.length === 0) {
          results.innerHTML = `
            <h3>âœ… No Old Gigs Found</h3>
            <p>All gigs have proper Firebase IDs!</p>
          `;
          cleanOldGigsBtn.disabled = false;
          return;
        }
        
        // Show list and confirm
        let listHTML = oldGigs.map(gig => 
          `<li><strong>${gig.title}</strong> (${gig.category}) - ID: ${gig.id}</li>`
        ).join('');
        
        results.innerHTML = `
          <h3>âš ï¸ Found ${oldGigs.length} Old Test Gig(s)</h3>
          <ul style="text-align: left; margin: 15px 0;">${listHTML}</ul>
          <button class="btn btn-danger" onclick="confirmDeleteOldGigs(${JSON.stringify(oldGigs).replace(/"/g, '&quot;')})">
            Confirm Delete
          </button>
        `;
        
      } catch (error) {
        console.error('âŒ Error scanning:', error);
        results.innerHTML = `
          <h3>âŒ Error</h3>
          <p>${error.message}</p>
        `;
      } finally {
        cleanOldGigsBtn.disabled = false;
      }
    }
    
    async function confirmDeleteOldGigs(oldGigs) {
      if (!confirm(`Delete ${oldGigs.length} old test gig(s)?\n\nThis cannot be undone!`)) {
        return;
      }
      
      const results = document.getElementById('results');
      results.innerHTML = '<div class="loading"><div class="spinner"></div><p>Deleting old gigs...</p></div>';
      
      try {
        const db = firebase.firestore();
        const batch = db.batch();
        
        oldGigs.forEach(gig => {
          batch.delete(db.collection('jobs').doc(gig.id));
        });
        
        await batch.commit();
        
        results.innerHTML = `
          <h3>âœ… Deleted Successfully</h3>
          <p><strong>${oldGigs.length} old test gig(s) removed!</strong></p>
          <p style="margin-top: 10px;">Refresh your listings page to see changes.</p>
        `;
        
        console.log(`âœ… Deleted ${oldGigs.length} old gigs`);
        
      } catch (error) {
        console.error('âŒ Error deleting:', error);
        results.innerHTML = `
          <h3>âŒ Error</h3>
          <p>${error.message}</p>
        `;
      }
    }
    
    // Check Firebase auth on load
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof firebase === 'undefined') {
        alert('Firebase not loaded! Please check your internet connection.');
        return;
      }
      
      firebase.auth().onAuthStateChanged(function(user) {
        if (!user) {
          alert('Please log in first!');
          window.location.href = 'login.html';
        } else {
          console.log('âœ… Logged in as:', user.email);
        }
      });
    });
  </script>
</body>
</html>
