<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Count Diagnostic Tool</title>
    <link rel="icon" type="image/png" href="public/images/Gisugo-icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .section p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .section ul {
            margin-left: 20px;
            color: #555;
            line-height: 1.8;
        }
        .section li {
            margin-bottom: 8px;
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .code-block code {
            color: #f8f8f2;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .warning strong {
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            border-left-color: #0c5460;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .info strong {
            color: #0c5460;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .success strong {
            color: #155724;
        }
        .step {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }
        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 10px;
        }
        .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Application Count Diagnostic Guide</h1>
        <p class="subtitle">Understanding and fixing the applicationCount discrepancy issue</p>

        <div class="section">
            <h2>üìã Issue Summary</h2>
            <p><strong>Problem:</strong> A user sees "ALREADY APPLIED" on a gig, but the job poster sees <code>applicationCount: 0</code>.</p>
            <p><strong>What this means:</strong></p>
            <ul>
                <li>‚úÖ The application document <strong>WAS created</strong> in Firestore <code>applications</code> collection</li>
                <li>‚ùå The job document's <code>applicationCount</code> field <strong>WAS NOT incremented</strong></li>
            </ul>
        </div>

        <div class="section">
            <h2>üî¨ Root Cause Analysis</h2>
            <p>When an application is submitted, the code performs two operations:</p>
            <div class="code-block">
<code>// Step 1: Create application document
await db.collection('applications').add(application);

// Step 2: Update job's applicationCount
await db.collection('jobs').doc(jobId).update({
  applicationCount: firebase.firestore.FieldValue.increment(1),
  applicationIds: firebase.firestore.FieldValue.arrayUnion(appRef.id)
});</code>
            </div>
            
            <p><strong>Most likely causes:</strong></p>
            <ol>
                <li><strong>Silent failure:</strong> The second update call failed but the error wasn't caught or logged properly</li>
                <li><strong>Legacy data:</strong> The application was created before the increment logic was implemented</li>
                <li><strong>Permissions issue:</strong> The user doesn't have permission to update the job document (check Firestore rules)</li>
                <li><strong>Race condition:</strong> Multiple applications were submitted simultaneously, causing a conflict</li>
                <li><strong>Transaction failure:</strong> If these operations were in a transaction, the transaction may have partially completed</li>
            </ol>
        </div>

        <div class="section">
            <h2>üîç How to Verify in Firebase Console</h2>
            
            <div class="step">
                <span class="step-number">1</span>
                <strong>Find the Application Document</strong>
                <p>Go to Firebase Console ‚Üí Firestore Database ‚Üí <code>applications</code> collection</p>
                <p>Search for applications where:</p>
                <ul>
                    <li><code>applicantName</code> contains "Peter John Ang" or "Peter J. Ang"</li>
                    <li>Or search by <code>jobId</code> if you know the specific job ID</li>
                </ul>
                <p><strong>Check these fields:</strong></p>
                <ul>
                    <li><code>jobId</code> - Note this value</li>
                    <li><code>applicantName</code> - Should be "Peter John Ang"</li>
                    <li><code>createdAt</code> - When was this application created?</li>
                    <li><code>status</code> - Current status of the application</li>
                </ul>
            </div>

            <div class="step">
                <span class="step-number">2</span>
                <strong>Check the Job Document</strong>
                <p>Go to Firestore Database ‚Üí <code>jobs</code> collection</p>
                <p>Find the job document using the <code>jobId</code> from step 1</p>
                <p><strong>Check these fields:</strong></p>
                <ul>
                    <li><code>applicationCount</code> - What is the current value? (Should be ‚â• 1 if application exists)</li>
                    <li><code>applicationIds</code> - Is the application ID from step 1 in this array?</li>
                    <li><code>postedBy</code> or <code>posterName</code> - Should be "Peter J. Ang"</li>
                </ul>
            </div>

            <div class="step">
                <span class="step-number">3</span>
                <strong>Count Actual Applications</strong>
                <p>In Firestore Console, go to <code>applications</code> collection</p>
                <p>Use the filter: <code>jobId == "[the job ID from step 1]"</code></p>
                <p><strong>Count how many application documents exist for this job</strong></p>
                <p>Compare this count with the <code>applicationCount</code> value in the job document</p>
            </div>

            <div class="info">
                <strong>üí° Quick Check:</strong> If you see multiple applications for the same job but <code>applicationCount</code> is 0 or lower than the actual count, you've confirmed the discrepancy.
            </div>
        </div>

        <div class="section">
            <h2>üõ†Ô∏è How to Fix the Issue</h2>
            
            <h3>Option 1: Manual Fix in Firebase Console (Quick Fix)</h3>
            <div class="step">
                <span class="step-number">1</span>
                <p>Go to Firestore Database ‚Üí <code>jobs</code> collection</p>
            </div>
            <div class="step">
                <span class="step-number">2</span>
                <p>Find the affected job document</p>
            </div>
            <div class="step">
                <span class="step-number">3</span>
                <p>Click "Edit document"</p>
            </div>
            <div class="step">
                <span class="step-number">4</span>
                <p>Update the <code>applicationCount</code> field:</p>
                <ul>
                    <li>Count all applications for this job (from <code>applications</code> collection)</li>
                    <li>Set <code>applicationCount</code> to that number</li>
                </ul>
            </div>
            <div class="step">
                <span class="step-number">5</span>
                <p>Update the <code>applicationIds</code> array:</p>
                <ul>
                    <li>Get all application document IDs for this job</li>
                    <li>Add them to the <code>applicationIds</code> array (if the field exists)</li>
                </ul>
            </div>

            <h3 style="margin-top: 30px;">Option 2: Re-apply Logic (Recommended for Future Prevention)</h3>
            <div class="warning">
                <strong>‚ö†Ô∏è Important:</strong> Before implementing this, ensure the application submission code has proper error handling.
            </div>
            
            <p><strong>Update the application submission code to:</strong></p>
            <div class="code-block">
<code>try {
  // Step 1: Create application document
  const appRef = await db.collection('applications').add(application);
  
  // Step 2: Update job's applicationCount (with error handling)
  try {
    await db.collection('jobs').doc(jobId).update({
      applicationCount: firebase.firestore.FieldValue.increment(1),
      applicationIds: firebase.firestore.FieldValue.arrayUnion(appRef.id)
    });
    console.log('Job applicationCount updated successfully');
  } catch (updateError) {
    console.error('Failed to update job applicationCount:', updateError);
    // Optionally: Delete the application if the update fails
    // await appRef.delete();
    throw updateError; // Re-throw to handle in UI
  }
} catch (error) {
  console.error('Application submission failed:', error);
  // Show error to user
  throw error;
}</code>
            </div>

            <h3 style="margin-top: 30px;">Option 3: Use Firestore Transactions (Best Practice)</h3>
            <p>To ensure atomicity (both operations succeed or both fail):</p>
            <div class="code-block">
<code>await db.runTransaction(async (transaction) => {
  // Create application
  const appRef = db.collection('applications').doc();
  transaction.set(appRef, application);
  
  // Update job
  const jobRef = db.collection('jobs').doc(jobId);
  transaction.update(jobRef, {
    applicationCount: firebase.firestore.FieldValue.increment(1),
    applicationIds: firebase.firestore.FieldValue.arrayUnion(appRef.id)
  });
  
  return appRef.id;
});</code>
            </div>
            <div class="info">
                <strong>üí° Note:</strong> Transactions ensure both operations complete together or both fail, preventing this type of discrepancy.
            </div>
        </div>

        <div class="section">
            <h2>üîí Check Firestore Security Rules</h2>
            <p>Verify that your Firestore rules allow users to update job documents:</p>
            <div class="code-block">
<code>// Example rule (adjust based on your actual rules)
match /jobs/{jobId} {
  allow update: if request.auth != null 
    && (resource.data.postedBy == request.auth.uid 
        || request.auth.token.admin == true);
}</code>
            </div>
            <p><strong>Common issues:</strong></p>
            <ul>
                <li>Users can create applications but cannot update jobs</li>
                <li>The <code>applicationCount</code> field update is blocked by rules</li>
                <li>Rules check for specific user roles that aren't set correctly</li>
            </ul>
        </div>

        <div class="section">
            <h2>üìä Prevention Checklist</h2>
            <ul>
                <li>‚úÖ Use Firestore transactions for atomic operations</li>
                <li>‚úÖ Add comprehensive error handling and logging</li>
                <li>‚úÖ Verify Firestore security rules allow necessary updates</li>
                <li>‚úÖ Add client-side validation before submission</li>
                <li>‚úÖ Consider using Cloud Functions to handle application submission server-side</li>
                <li>‚úÖ Add monitoring/alerts for application count discrepancies</li>
                <li>‚úÖ Periodically audit applicationCount values against actual application counts</li>
            </ul>
        </div>

        <div class="section">
            <h2>üìù Summary</h2>
            <div class="success">
                <strong>Quick Action Items:</strong>
                <ol>
                    <li>Verify the discrepancy in Firebase Console (check both collections)</li>
                    <li>Manually fix the <code>applicationCount</code> for affected jobs</li>
                    <li>Review and update application submission code with proper error handling</li>
                    <li>Consider implementing transactions for future submissions</li>
                    <li>Audit Firestore security rules</li>
                </ol>
            </div>
        </div>
    </div>
</body>
</html>
